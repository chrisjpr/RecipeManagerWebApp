{% extends 'base.html' %}
{% load static %}

{% block title %}Friends Dashboard | Recipe Manager{% endblock %}

{% block breadcrumbs %}
<nav aria-label="Breadcrumb" class="mb-3 text-sm text-gray-600 dark:text-gray-300">
  <ol class="flex flex-wrap items-center gap-1">
    <li><a class="underline hover:no-underline" href="{% url 'recipes:home' %}">Home</a></li>
    <li class="opacity-60">/</li>
    <li class="font-semibold">Friends</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<h1 class="text-2xl md:text-3xl font-extrabold tracking-tight flex items-center gap-2">üë• Friends Dashboard</h1>

{# Django messages #}
{% if messages %}
  <div class="mt-4 space-y-2">
    {% for message in messages %}
      <div class="rounded-xl px-4 py-3 text-sm font-medium
                  {% if message.tags == 'success' %} bg-emerald-50 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-200
                  {% elif message.tags == 'error' or message.tags == 'danger' %} bg-rose-50 text-rose-800 dark:bg-rose-900/30 dark:text-rose-200
                  {% elif message.tags == 'warning' %} bg-amber-50 text-amber-800 dark:bg-amber-900/30 dark:text-amber-200
                  {% else %} bg-slate-100 text-slate-800 dark:bg-slate-800/70 dark:text-slate-100 {% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

{# --- Your Friends --- #}
{% if friends %}
<section class="mt-6 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-black/5 shadow-card">
  <div class="p-4 md:p-5">
    <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
      <div>
        <h2 class="text-lg font-semibold flex items-center gap-2">‚úÖ Your Friends</h2>
        <p class="text-sm text-gray-600 dark:text-gray-300">Browse your friends, open their recipes, or remove them.</p>
      </div>

      <!-- Name filter -->
      <div class="w-full md:w-80">
        <label for="friend-search" class="block text-sm font-semibold mb-1">Search Friends</label>
        <div class="relative">
          <span class="material-symbols-rounded absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">search</span>
          <input id="friend-search" type="text" placeholder="Type a username‚Ä¶"
                 class="w-full rounded-xl border-gray-300 pl-9 py-2 text-sm focus:ring-2 focus:ring-emerald-500 dark:bg-slate-900 dark:border-slate-700" autocomplete="off">
        </div>
        <div id="friend-count" class="mt-1 text-xs text-gray-600 dark:text-gray-300"></div>
      </div>
    </div>

    <div class="mt-4 overflow-x-auto">
      <table id="friends-table" class="min-w-full text-sm">
        <colgroup>
          <col style="width:auto">
          <col style="width:9rem">
          <col style="width:10rem">
        </colgroup>
        <thead>
          <tr class="bg-emerald-50/80 dark:bg-slate-700/60">
            <th class="p-3 text-left font-semibold">Username</th>
            <th class="p-3 text-center font-semibold">View Recipes</th>
            <th class="p-3 text-center font-semibold">Delete Friend</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 dark:divide-slate-700">
          {% for friend in friends %}
          <tr class="hover:bg-gray-50/70 dark:hover:bg-slate-800/60">
            <td class="p-3 align-middle font-medium">{{ friend.username }}</td>
            <td class="p-3 align-middle text-center">
              <a href="{% url 'recipes:friends_recipes' friend.id %}"
                 class="inline-flex items-center gap-1 rounded-lg bg-slate-700 text-white px-3 py-1.5 font-semibold hover:bg-slate-800">
                <span class="material-symbols-rounded text-base">book_4</span> Open
              </a>
            </td>
            <td class="p-3 align-middle text-center">
              <form method="post" action="{% url 'accounts:delete_friend' friend.id %}"
                    onsubmit="return confirm('Remove {{ friend.username }} as a friend?');" class="inline-block">
                {% csrf_token %}
                <button type="submit"
                        class="inline-flex items-center gap-1 rounded-lg bg-rose-600 text-white px-3 py-1.5 font-semibold hover:bg-rose-700">
                  <span class="material-symbols-rounded text-base">person_remove</span> Remove
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
{% else %}
<p class="subtitle mt-6 text-slate-700 dark:text-slate-200">You have no friends yet. üò¢</p>
{% endif %}

{# --- Send Friend Request --- #}
<section class="mt-6 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-black/5 shadow-card">
  <div class="p-4 md:p-5">
    <h2 class="text-lg font-semibold mb-2">‚ûï Send Friend Request</h2>
    <form method="get" action="{% url 'accounts:friend_search' %}" class="flex flex-col gap-2 sm:flex-row sm:items-center">
      <input type="text" name="q" placeholder="Search username" required
             class="flex-1 rounded-xl border-gray-300 py-2 px-3 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-900 dark:border-slate-700">
      <button type="submit"
              class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 text-white px-4 py-2 font-semibold hover:bg-emerald-700">
        <span class="material-symbols-rounded">search</span> Search
      </button>
    </form>
  </div>
</section>

{# --- Search Results --- #}
{% if results %}
<section class="mt-6 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-black/5 shadow-card">
  <div class="p-4 md:p-5">
    <h2 class="text-base font-semibold mb-3">üîé Search Results</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <colgroup>
          <col style="width:auto">
          <col style="width:9rem">
        </colgroup>
        <thead>
          <tr class="bg-emerald-50/80 dark:bg-slate-700/60">
            <th class="p-3 text-left font-semibold">Username</th>
            <th class="p-3 text-center font-semibold">Send Request</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 dark:divide-slate-700">
          {% for user in results %}
          <tr class="hover:bg-gray-50/70 dark:hover:bg-slate-800/60">
            <td class="p-3 align-middle font-medium">{{ user.username }}</td>
            <td class="p-3 align-middle text-center">
              <form method="post" action="{% url 'accounts:send_friend_request' user.id %}" class="inline-block">
                {% csrf_token %}
                <button type="submit"
                        class="inline-flex items-center gap-1 rounded-lg bg-slate-700 text-white px-3 py-1.5 font-semibold hover:bg-slate-800">
                  <span class="material-symbols-rounded text-base">person_add</span> Add
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
{% endif %}

{# --- Incoming Requests --- #}
{% if received_requests %}
<section class="mt-6 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-black/5 shadow-card">
  <div class="p-4 md:p-5">
    <h2 class="text-lg font-semibold mb-3">üì© Friend Requests (Received)</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <colgroup>
          <col style="width:auto">
          <col style="width:7.5rem">
          <col style="width:7.5rem">
        </colgroup>
        <thead>
          <tr class="bg-emerald-50/80 dark:bg-slate-700/60">
            <th class="p-3 text-left font-semibold">Username</th>
            <th class="p-3 text-center font-semibold">Accept</th>
            <th class="p-3 text-center font-semibold">Decline</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 dark:divide-slate-700">
          {% for request in received_requests %}
          <tr class="hover:bg-gray-50/70 dark:hover:bg-slate-800/60">
            <td class="p-3 align-middle font-medium">{{ request.from_user.username }}</td>
            <td class="p-3 align-middle text-center">
              <form method="post" action="{% url 'accounts:accept_friend_request' request.id %}" class="inline-block">
                {% csrf_token %}
                <button type="submit"
                        class="inline-flex items-center gap-1 rounded-lg bg-emerald-600 text-white px-3 py-1.5 font-semibold hover:bg-emerald-700">
                  <span class="material-symbols-rounded text-base">check</span> Accept
                </button>
              </form>
            </td>
            <td class="p-3 align-middle text-center">
              <form method="post" action="{% url 'accounts:decline_friend_request' request.id %}" class="inline-block">
                {% csrf_token %}
                <button type="submit"
                        class="inline-flex items-center gap-1 rounded-lg bg-rose-600 text-white px-3 py-1.5 font-semibold hover:bg-rose-700">
                  <span class="material-symbols-rounded text-base">close</span> Decline
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
{% endif %}

{# --- Sent Requests --- #}
{% if sent_requests %}
<section class="mt-6 rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-black/5 shadow-card">
  <div class="p-4 md:p-5">
    <h2 class="text-lg font-semibold mb-3">üì§ Friend Requests (Sent)</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <colgroup>
          <col style="width:auto">
          <col style="width:8rem">
        </colgroup>
        <thead>
          <tr class="bg-emerald-50/80 dark:bg-slate-700/60">
            <th class="p-3 text-left font-semibold">Username</th>
            <th class="p-3 text-center font-semibold">Status</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 dark:divide-slate-700">
          {% for request in sent_requests %}
          <tr class="hover:bg-gray-50/70 dark:hover:bg-slate-800/60">
            <td class="p-3 align-middle font-medium">{{ request.to_user.username }}</td>
            <td class="p-3 align-middle text-center">‚è≥ Pending</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
  // Simple client-side filter for your friends table
  (function(){
    const input = document.getElementById('friend-search');
    const table = document.getElementById('friends-table');
    const rows  = () => table?.querySelectorAll('tbody tr') || [];
    const count = document.getElementById('friend-count');

    function apply(){
      const q = (input?.value || '').trim().toLowerCase();
      let shown = 0;
      rows().forEach(tr=>{
        const name = (tr.querySelector('td')?.textContent || '').trim().toLowerCase();
        const show = !q || name.includes(q);
        tr.style.display = show ? '' : 'none';
        if (show) shown++;
      });
      if (count){
        const total = rows().length;
        count.textContent = q ? `Showing ${shown} of ${total}` : `${total} friend${total===1?'':'s'}`;
      }
    }

    if (input){
      input.addEventListener('input', apply);
      apply();
    }
  })();
</script>
{% endblock %}
