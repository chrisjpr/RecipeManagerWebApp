<!DOCTYPE html>
<html lang="en" class="h-full scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <title>{% block title %}Recipe Manager{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#4CAF50" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Material Symbols (still used in a few spots) -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@400;700" rel="stylesheet">

  <!-- Iconify (kept for compatibility) -->
  <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js" defer></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: '#4CAF50',
            brandDark: '#388E3C',
            brandAccent: '#FFC107',
          },
          boxShadow: { card: '0 10px 25px rgba(0,0,0,0.08)' },
          borderRadius: { xl: '0.75rem', '2xl': '1rem' },
          keyframes: {
            slideDown: { '0%': { transform: 'translateY(-8px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
            slideUp: { '0%': { transform: 'translateY(0)', opacity: 1 }, '100%': { transform: 'translateY(-8px)', opacity: 0 } }
          },
          animation: {
            slideDown: 'slideDown .16s ease-out forwards',
            slideUp: 'slideUp .14s ease-in forwards',
          }
        }
      },
      darkMode: 'class'
    }
  </script>

  <script>
/**
 * Global RQ job poller.
 * - Picks up one or more job IDs from a short-lived cookie `last_import_job`
 *   (comma-separated), moves them into localStorage for persistence, and polls
 *   until "finished" or "failed" (max ~12 minutes by default).
 * - On failure, injects a red flash banner matching your existing styles.
 */
(function(){
  const STATUS_URL = "{% url 'recipes:job_status' %}";

  // --- Helpers -----------------------------------------------------------
  const storageKey = "pendingImportJobs";
  function readCookieJobs(){
    const m = document.cookie.match(/(?:^|; )last_import_job=([^;]+)/);
    if (!m) return [];
    // Clear cookie
    document.cookie = "last_import_job=; Max-Age=0; path=/; SameSite=Lax";
    try {
      const raw = decodeURIComponent(m[1]);
      return raw.split(",").map(s => s.trim()).filter(Boolean);
    } catch { return []; }
  }
  function loadQueue(){
    try { return JSON.parse(localStorage.getItem(storageKey) || "[]"); }
    catch { return []; }
  }
  function saveQueue(arr){
    localStorage.setItem(storageKey, JSON.stringify(Array.from(new Set(arr))));
  }
  function enqueueJobs(ids){
    const q = loadQueue();
    ids.forEach(id => { if (id && !q.includes(id)) q.push(id); });
    saveQueue(q);
  }
  function removeJob(id){
    saveQueue(loadQueue().filter(x => x !== id));
  }

  function flash(kind, text){
    // Use your #flashRegion container + Tailwind classes mapped in base.html
    const host = document.getElementById("flashRegion") || (function(){
      const div = document.createElement('div');
      div.id = 'flashRegion';
      div.className = 'space-y-3';
      const container = document.querySelector('.container-max .px-4') || document.body;
      container.prepend(div);
      return div;
    })();

    const wrapper = document.createElement('div');
    wrapper.className = 'flex items-start gap-3 rounded-2xl p-4 shadow-card ring-1 ring-black/5';
    wrapper.setAttribute('data-flash','');
    wrapper.setAttribute('data-tag', kind);

    const icon = document.createElement('span');
    icon.className = 'material-symbols-rounded mt-0.5';
    const iconFor = (tag)=>({ success:'check_circle', error:'error', warning:'warning', info:'info' }[tag]||'info');
    icon.textContent = iconFor(kind);

    const body = document.createElement('div');
    body.className = 'flex-1';
    body.textContent = text;

    const close = document.createElement('button');
    close.className = 'shrink-0 p-1 rounded hover:bg-black/5';
    close.setAttribute('aria-label','Dismiss');
    close.innerHTML = '<span class="material-symbols-rounded">close</span>';
    close.addEventListener('click', ()=> wrapper.remove());

    wrapper.append(icon, body, close);
    host.prepend(wrapper);

    // Apply the same colorization & auto-dismiss you already do
    (function(el){
      const tag = el.getAttribute('data-tag');
      const colorFor = (t)=>({
        success:['bg-emerald-50','text-emerald-800'],
        error:['bg-rose-50','text-rose-800'],
        warning:['bg-amber-50','text-amber-800'],
        info:['bg-sky-50','text-sky-800']
      })[t]||['bg-gray-50','text-gray-800'];
      const [bg, fg] = colorFor(tag);
      el.classList.add(bg, fg);
      setTimeout(()=>{ if(document.body.contains(el)) el.remove(); }, 10000);
    })(wrapper);
  }

  // Map error_code -> human text (same messages you wanted)
  function humanError(error){
    const map = {
      webpage_not_found: "âŒ The recipe could not be imported. The webpage could not be found.",
      url_import_failed: "âŒ The recipe could not be imported from the URL.",
      no_main_image: "âŒ The recipe could not be imported. No main image of the dish could be extracted.",
      image_import_failed: "âŒ The recipe could not be imported from the image.",
      manual_too_ambiguous: "âŒ The recipe could not be imported. Manual import is more prone to errors and the provided text was too ambiguous.",
      manual_import_failed: "âŒ The recipe could not be imported from manual input."
    };
    return map[error?.error_code] || ("âŒ The recipe could not be imported." + (error?.error_message ? " " + error.error_message : ""));
  }

  // --- Boot: pull cookies into persistent queue -------------------------
  const newIds = readCookieJobs();
  if (newIds.length) enqueueJobs(newIds);

  // If nothing to poll, bail early
  if (!loadQueue().length) return;

  // --- Poll loop with gentle backoff ------------------------------------
  // Strategy: poll each job every 5s, backoff to 10s after 2 minutes.
  // Hard stop after 12 minutes (typical 1â€“3 min jobs are covered; errors at 2m are caught).
  const firstSeenAt = {};
  const timers = {};

  function pollOne(jobId){
    if (!firstSeenAt[jobId]) firstSeenAt[jobId] = Date.now();
    fetch(STATUS_URL + "?job_id=" + encodeURIComponent(jobId), { credentials: 'same-origin' })
      .then(r => r.json())
      .then(data => {
        if (data.status === "failed") {
          flash('error', humanError(data));
          removeJob(jobId);
          clearTimeout(timers[jobId]);
          delete timers[jobId];
          return;
        }
        if (data.status === "finished") {
          // We already show a success banner on enqueue, so stay quiet here.
          removeJob(jobId);
          clearTimeout(timers[jobId]);
          delete timers[jobId];
          return;
        }

        // Keep polling while queued/started
        const elapsed = Date.now() - firstSeenAt[jobId];
        const next = elapsed > 120000 ? 10000 : 5000; // 2min -> 10s backoff
        // Hard timeout at ~12 minutes: show a soft error
        if (elapsed > 12 * 60 * 1000) {
          flash('error', "âŒ The recipe import may have stalled. Youâ€™ll be notified if it ultimately fails.");
          removeJob(jobId);
          clearTimeout(timers[jobId]);
          delete timers[jobId];
          return;
        }
        timers[jobId] = setTimeout(()=> pollOne(jobId), next);
      })
      .catch(() => {
        // Network hiccup: retry in 10s without dropping the job
        timers[jobId] = setTimeout(()=> pollOne(jobId), 10000);
      });
  }

  loadQueue().forEach(id => pollOne(id));
})();
</script>


  

  <!-- App tokens -->
  <style>
    :root{
      --primary-color:#4CAF50;
      --secondary-color:#388E3C;
      --accent-color:#FFC107;
      --background-color:#f8f9fa;
      --text-color:#2c3e50;
      --card-bg:#fff;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --header-h:64px;               /* desktop default */
      --bottom-nav-h:64px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    /* Smaller header on phones */
    @media (max-width: 767px){
      :root{ --header-h:52px; }
    }
    *{box-sizing:border-box}
    html,body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .card{background:var(--card-bg); padding:1.25rem; border-radius:12px; box-shadow:var(--shadow);}
    .message{padding:1rem; border-radius:10px; font-weight:600}
    .message.success{background:#d1fae5; color:#065f46}
    .message.error{background:#fee2e2; color:#7f1d1d}
    .material-symbols-rounded{font-variation-settings:'FILL' 0,'wght' 600,'GRAD' 0,'opsz' 24; line-height:1}
    .help-popover{position:relative;}
    .help-popover[open] > summary {background:rgba(76,175,80,.12)}
    .help-badge{display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; border-radius:999px; font-size:12px; font-weight:800}
    @media (min-width:1024px){.container-max{max-width:1100px}}
    .skip-link{position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden}
    .skip-link:focus{position:fixed; left:1rem; top:1rem; z-index:9999; width:auto; height:auto; padding:.5rem .75rem; background:#111827; color:#fff; border-radius:.5rem}
    /* Make space for bottom nav on small screens */
    @media (max-width: 767px){
      main{ padding-bottom: calc(var(--bottom-nav-h) + var(--safe-bottom) + 12px); }
    }
  </style>

  {% block extra_head %}{% endblock %}
</head>
<body class="min-h-screen bg-[var(--background-color)] text-[var(--text-color)] antialiased flex flex-col">
  <a href="#main" class="skip-link">Skip to content</a>

  <!-- Header -->
  <header class="sticky top-0 z-50 bg-brand text-white shadow" style="padding-top: var(--safe-top);">
    <div class="container-max mx-auto px-4 h-[var(--header-h)] flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <a href="{% url 'recipes:home' %}" class="flex items-center gap-2 text-white no-underline">
          <span class="text-2xl">ğŸ³</span>
          <!-- Hide brand text on phones to save vertical space -->
          <span class="hidden sm:inline text-xl lg:text-2xl font-extrabold tracking-tight">Recipe&nbsp;Manager</span>
        </a>
      </div>

      <!-- Desktop nav (unchanged) -->
      <nav class="hidden md:flex items-center gap-1 lg:gap-2" aria-label="Primary">
        <a href="{% url 'recipes:home' %}" class="px-3 py-2 rounded-lg font-semibold hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/40">ğŸ  Home</a>
        <a href="{% url 'recipes:recipe_list' %}" class="px-3 py-2 rounded-lg font-semibold hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/40">ğŸ“– My Recipes</a>
        <a href="{% url 'recipes:public_recipes' %}" class="px-3 py-2 rounded-lg font-semibold hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/40">ğŸŒ Public</a>
        <a href="{% url 'recipes:create_recipe_landing' %}" class="px-3 py-2 rounded-lg font-semibold hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/40">â• Create</a>
        <a href="{% url 'accounts:friend_dashboard' %}" class="px-3 py-2 rounded-lg font-semibold hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/40">ğŸ‘¥ Friends</a>
      </nav>

      <!-- Right (desktop) -->
      <div class="hidden md:flex items-center gap-2">
        <div class="relative">
          {% if user.is_authenticated %}
            <details class="group relative">
              <summary class="list-none cursor-pointer flex items-center gap-2 px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15 focus:outline-none focus:ring-2 focus:ring-white/40">
                <span class="text-lg leading-none">{{ user.profile_icon|default:"ğŸ¾" }}</span>
                <span class="font-semibold">@{{ user.username|cut:"_" }}</span>
                <span class="material-symbols-rounded text-sm">expand_more</span>
              </summary>
              <div class="absolute right-0 mt-2 w-56 bg-white text-gray-800 rounded-xl shadow-card ring-1 ring-black/5 overflow-hidden">
                <a href="{% url 'accounts:settings' %}" class="flex items-center gap-2 px-4 py-3 hover:bg-gray-50">
                  <span class="material-symbols-rounded">settings</span>
                  <span>Account Settings</span>
                </a>
                <a href="{% url 'accounts:logout' %}" class="flex items-center gap-2 px-4 py-3 hover:bg-gray-50">
                  <span class="material-symbols-rounded">logout</span>
                  <span>Logout</span>
                </a>
              </div>
            </details>
          {% else %}
            <a href="{% url 'accounts:login' %}" class="px-3 py-2 rounded-lg bg-white/15 hover:bg-white/20 font-semibold">ğŸ”‘ Login</a>
          {% endif %}
        </div>
      </div>

      <!-- Mobile controls -->
      <div class="md:hidden flex items-center gap-1">
        <button id="navToggle"
                class="p-2 rounded-lg bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/40"
                aria-expanded="false" aria-controls="mobileMenu" aria-label="Open menu">
          <span class="material-symbols-rounded">menu</span>
        </button>
      </div>
    </div>

    <!-- Mobile menu: fixed sheet under header -->
    <div id="mobileMenu"
         class="md:hidden hidden fixed top-[calc(var(--safe-top)+var(--header-h))] inset-x-0 z-50 border-t border-gray-200 bg-white text-gray-800 will-change-transform origin-top max-h-[70vh] overflow-auto shadow-card">
      <div class="container-max mx-auto px-4 py-3 grid gap-1">
        <a class="px-3 py-2 rounded-lg hover:bg-gray-50 font-semibold" href="{% url 'recipes:home' %}">ğŸ  Home</a>
        <a class="px-3 py-2 rounded-lg hover:bg-gray-50 font-semibold" href="{% url 'recipes:recipe_list' %}">ğŸ“– My Recipes</a>
        <a class="px-3 py-2 rounded-lg hover:bg-gray-50 font-semibold" href="{% url 'recipes:public_recipes' %}">ğŸŒ Public Recipes</a>
        <a class="px-3 py-2 rounded-lg hover:bg-gray-50 font-semibold" href="{% url 'recipes:create_recipe_landing' %}">â• Create Recipe</a>
        <a class="px-3 py-2 rounded-lg hover:bg-gray-50 font-semibold" href="{% url 'accounts:friend_dashboard' %}">ğŸ‘¥ Friends</a>

        <div class="mt-2 rounded-xl border border-gray-200 bg-gray-50 p-3 flex items-center justify-between">
          {% if user.is_authenticated %}
            <div class="flex items-center gap-2">
              <span class="text-lg leading-none">{{ user.profile_icon|default:"ğŸ¾" }}</span>
              <a href="{% url 'accounts:settings' %}" class="font-semibold">@{{ user.username|cut:"_" }}</a>
            </div>
            <a href="{% url 'accounts:logout' %}" class="font-semibold">ğŸšª Logout</a>
          {% else %}
            <a href="{% url 'accounts:login' %}" class="font-semibold">ğŸ”‘ Login</a>
          {% endif %}
        </div>
      </div>
    </div>
  </header>

  <main id="main" class="flex-1">
    <div class="container-max mx-auto px-4 py-4 md:py-6">
      {% if messages %}
        <div class="space-y-3" id="flashRegion">
          {% for message in messages %}
            <div class="flex items-start gap-3 rounded-2xl p-4 shadow-card ring-1 ring-black/5"
                 data-flash
                 data-tag="{{ message.tags }}">
              <span class="material-symbols-rounded mt-0.5"></span>
              <div class="flex-1">{{ message }}</div>
              <button class="shrink-0 p-1 rounded hover:bg-black/5" aria-label="Dismiss">
                <span class="material-symbols-rounded">close</span>
              </button>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% block breadcrumbs %}{% endblock %}

      <section class="card md:rounded-2xl md:shadow-card md:ring-1 md:ring-black/5 md:bg-white md:p-6">
        {% block content %}{% endblock %}
      </section>

      {% block modals %}{% endblock %}
    </div>
  </main>

  <!-- Bottom mobile nav -->
  <nav class="md:hidden fixed inset-x-0 bottom-0 z-40 bg-white border-t border-gray-200"
       style="padding-bottom: var(--safe-bottom);">
    <ul class="grid grid-cols-4 text-sm text-gray-700" style="height: calc(var(--bottom-nav-h) + var(--safe-bottom));">
      <li><a href="{% url 'recipes:home' %}" class="flex flex-col items-center gap-1 py-2.5">
        <span class="material-symbols-rounded">home</span><span>Home</span></a></li>
      <li><a href="{% url 'recipes:recipe_list' %}" class="flex flex-col items-center gap-1 py-2.5">
        <span class="material-symbols-rounded">menu_book</span><span>My</span></a></li>
      <li><a href="{% url 'recipes:create_recipe_landing' %}" class="flex flex-col items-center gap-1 py-2.5">
        <span class="material-symbols-rounded">add_circle</span><span>Create</span></a></li>
      <li><a href="{% url 'accounts:friend_dashboard' %}" class="flex flex-col items-center gap-1 py-2.5">
        <span class="material-symbols-rounded">group</span><span>Friends</span></a></li>
    </ul>
  </nav>

  <footer class="mt-10 border-t border-gray-200 bg-gray-50" style="padding-bottom: var(--safe-bottom);">
    <div class="container-max mx-auto px-4 py-6 text-center text-sm text-gray-600">
      &copy; {{ year|default:"2025" }} RecipeManager ğŸŒ±ğŸ¦Â·
    </div>
  </footer>

  <script>
    // --- Mobile menu toggle (animated, overlay, escape) -----------------
    (function(){
      const btn = document.getElementById('navToggle');
      const panel = document.getElementById('mobileMenu');
      if(!btn || !panel) return;

      let open = false;

      // Create overlay for outside click; keep header tappable
      const overlay = document.createElement('div');
      overlay.id = 'mobileOverlay';
      overlay.className = 'md:hidden hidden fixed inset-x-0 bottom-0 bg-black/30';
      overlay.style.top = 'calc(var(--safe-top) + var(--header-h))';
      document.body.appendChild(overlay);

      function lockScroll(lock){
        document.documentElement.style.overflow = lock ? 'hidden' : '';
        document.body.style.overflow = lock ? 'hidden' : '';
      }
      function show(){
        open = true;
        btn.setAttribute('aria-expanded','true');
        overlay.classList.remove('hidden');
        panel.classList.remove('hidden','animate-slideUp');
        panel.classList.add('animate-slideDown');
        lockScroll(true);
      }
      function hide(){
        open = false;
        btn.setAttribute('aria-expanded','false');
        panel.classList.remove('animate-slideDown');
        panel.classList.add('animate-slideUp');
        setTimeout(()=>{ panel.classList.add('hidden'); overlay.classList.add('hidden'); lockScroll(false); }, 130);
      }

      btn.addEventListener('click', ()=> open ? hide() : show());
      overlay.addEventListener('click', hide);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && open) hide(); });
    })();

    // --- Flash messages (icons + auto dismiss) --------------------------
    (function(){
      const iconFor = (tag)=>({ success:'check_circle', error:'error', warning:'warning', info:'info' }[tag]||'info');
      const colorFor = (tag)=>({
        success:['bg-emerald-50','text-emerald-800'],
        error:['bg-rose-50','text-rose-800'],
        warning:['bg-amber-50','text-amber-800'],
        info:['bg-sky-50','text-sky-800']
      })[tag]||['bg-gray-50','text-gray-800'];
      document.querySelectorAll('[data-flash]').forEach(el=>{
        const tag = el.getAttribute('data-tag');
        const [bg, fg] = colorFor(tag);
        el.classList.add(bg, fg);
        const icon = el.querySelector('.material-symbols-rounded');
        if (icon) icon.textContent = iconFor(tag);
        el.querySelector('button')?.addEventListener('click', ()=> el.remove());
        setTimeout(()=>{ if(document.body.contains(el)) el.remove(); }, 6000);
      });
    })();

    // --- Dismiss helper --------------------------------------------------
    (function(){
      document.querySelectorAll('[data-dismiss]')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-dismiss');
          const el = document.getElementById(id);
          if (el) el.style.display = 'none';
        });
      })
    })();

    // --- Tiny helper: "?" popovers --------------------------------------
    // <details class="help-popover inline-block align-middle">
    //   <summary class="help-badge bg-brand/15 text-brand hover:bg-brand/20 select-none">?</summary>
    //   <div class="mt-2 w-72 max-w-[80vw] p-3 bg-white rounded-xl shadow-card ring-1 ring-black/5 text-sm">
    //     Brief guidance about the adjacent field.
    //   </div>
    // </details>
  </script>

  {% block extra_scripts %}{% endblock %}
</body>
</html>
