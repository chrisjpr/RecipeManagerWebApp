{% extends 'base.html' %}
{% block title %}{{ friend.username|title }}‚Äôs Recipes | Recipe Manager{% endblock %}

{% block extra_head %}
<style>
  /* Column alignment: fixed layout so <colgroup> widths are respected */
  #recipe-table { table-layout: fixed; border-collapse: separate; border-spacing: 0; }

  /* Hide the real thead visually but keep it for semantics (screen readers/sorting links) */
  #recipe-table thead.sr-only-thead{
    position:absolute; width:1px; height:1px; padding:0; margin:-1px;
    overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }

  /* Floating sticky header (single green bar; no overlap) */
  #floatingHead{
    position: sticky;
    top: calc(var(--site-header-h, 64px) + 8px);
    z-index: 40; /* above rows, below ingredient suggestions */
    background: rgba(236,253,245,.95);   /* emerald-50 */
    backdrop-filter: saturate(1.05) blur(2px);
    border-bottom: 1px solid rgba(0,0,0,.06);
  }
  .dark #floatingHead{
    background: rgba(51,65,85,.85);      /* slate-700 */
    border-bottom-color: rgba(255,255,255,.08);
  }
  #floatingHead .fh-grid{
    display: grid;
    grid-template-columns: var(--col-template, 5.5rem 1fr 6rem 7rem 8rem 6.5rem);
    align-items: center;
    column-gap: .25rem;
  }

  /* Push table down exactly by floating header height (prevents overlap) */
  #tableWrapper{ padding-top: var(--fh-h, 0px); }

  /* Ingredient suggestions must appear above everything */
  #ingredient-suggestions{ z-index: 9999 !important; }
</style>
{% endblock %}

{% block breadcrumbs %}
<nav aria-label="Breadcrumb" class="mb-3 text-sm text-gray-600 dark:text-gray-300">
  <ol class="flex flex-wrap items-center gap-1">
    <li><a class="underline hover:no-underline" href="{% url 'recipes:home' %}">Home</a></li>
    <li class="opacity-60">/</li>
    <li class="font-semibold">{{ friend.username|title }}‚Äôs Recipes</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<h1 class="text-2xl md:text-3xl font-extrabold tracking-tight flex items-center gap-2">üë©‚Äçüç≥ {{ friend.username|title }}‚Äôs Recipes</h1>

<section class="mt-4 grid gap-3 md:grid-cols-2">
  <!-- Filters -->
  <div class="rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-black/5 p-4 md:p-5 shadow-card">
    <h2 class="text-base font-semibold mb-3 flex items-center gap-2">üîé Filters</h2>
    <div class="grid gap-3">
      <!-- Title search -->
      <label class="block">
        <span class="block text-sm font-semibold mb-1">Search by Title</span>
        <div class="relative">
          <span class="material-symbols-rounded absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none">search</span>
          <input type="text" id="search" class="w-full rounded-xl border-gray-300 pl-9" placeholder="e.g., Pancakes, Carbonara" autocomplete="off">
        </div>
      </label>

      <!-- Ingredient search + suggestions -->
      <label class="block">
        <div class="flex items-center gap-2 mb-1">
          <span class="text-sm font-semibold">Filter by Ingredients</span>
          <details class="help-popover inline-block align-middle">
            <summary class="help-badge bg-brand/15 text-brand hover:bg-brand/20 select-none">?</summary>
            <div class="mt-2 w-80 max-w-[90vw] p-3 bg-white dark:bg-slate-800 rounded-xl shadow-card ring-1 ring-black/5 text-sm leading-relaxed">
              Click a suggestion or press <kbd>Enter</kbd> to add an ingredient. Active filters appear below; click <strong>√ó</strong> to remove. Matching requires <strong>all</strong> selected ingredients.
            </div>
          </details>
        </div>
        <div id="ingredient-search-container" class="relative rounded-xl border border-gray-300 p-2">
          <input type="text" id="ingredient-search" placeholder="Type ingredient‚Ä¶" autocomplete="off" class="w-full border-0 focus:ring-0 p-0">
          <div id="ingredient-suggestions" class="absolute left-0 right-0 top-full mt-1 z-20 hidden rounded-xl border border-gray-200 bg-white dark:bg-slate-800 shadow-card max-h-56 overflow-auto"></div>
        </div>
        <div id="ingredient-active-bar" class="mt-2 flex flex-wrap gap-1"></div>

        <!-- Drop filters -->
        <button id="drop_filters_btn" type="button"
          class="hidden mt-3 inline-flex items-center gap-2 rounded-xl ring-1 ring-black/5 bg-white dark:bg-slate-800 px-3 py-2 text-sm font-semibold hover:shadow-card">
          <span class="material-symbols-rounded text-base">filter_alt_off</span> Drop filters
        </button>
      </label>
    </div>
  </div>

  <!-- Info card -->
  <div class="rounded-2xl bg-white dark:bg-slate-800 ring-1 ring-black/5 p-4 md:p-5 shadow-card">
    <h2 class="text-base font-semibold mb-2">About {{ friend.username|title }}‚Äôs Recipes</h2>
    <p class="text-sm text-gray-700 dark:text-gray-200">
      These are recipes your friend shared. You can view details and <strong>copy</strong> any recipe to your own collection. Set the visibility of your own recipes to "Friends" or "Public" to let your friends see your recipies as well. <strong>Note:</strong> Remind your friends to make their recipes visible to you, otherwise you won't see their recipes here!
    </p>
  </div>
</section>

<!-- Floating header (populated by JS from the real thead) -->
<div id="floatingHead" class="rounded-t-xl mt-4"></div>

<!-- Table -->
<div id="tableWrapper" class="mt-2 overflow-x-auto relative">
  {% if page_obj %}
  <table id="recipe-table" class="min-w-full text-sm">
    <!-- Column widths sync header & rows -->
    <colgroup>
      <col style="width:5.5rem">   <!-- preview -->
      <col style="width:auto">     <!-- title -->
      <col style="width:6rem">     <!-- portions -->
      <col style="width:7rem">     <!-- cook time -->
      <col style="width:8rem">     <!-- created at -->
      <col style="width:6.5rem">   <!-- copy -->
    </colgroup>

    <!-- Keep semantics; JS will hide this thead and render a floating copy -->
    <thead id="real_thead">
      <tr class="bg-emerald-50/80 dark:bg-slate-700/60 backdrop-blur">
        <th class="w-20 p-3 text-left">Preview</th>
        <th class="p-3 text-left">
          {% if current_sort == 'title' %}
            {% if current_dir == 'asc' %}
              <a href="?sort=title&dir=desc" class="font-semibold">Title ‚ñ≤</a>
            {% else %}
              <a href="?sort=title&dir=asc" class="font-semibold">Title ‚ñº</a>
            {% endif %}
          {% else %}
            <a href="?sort=title&dir=asc" class="font-semibold">Title</a>
          {% endif %}
        </th>
        <th class="p-3 text-center">
          {% if current_sort == 'portions' %}
            {% if current_dir == 'asc' %}
              <a href="?sort=portions&dir=desc" class="font-semibold">Portions ‚ñ≤</a>
            {% else %}
              <a href="?sort=portions&dir=asc" class="font-semibold">Portions ‚ñº</a>
            {% endif %}
          {% else %}
            <a href="?sort=portions&dir=asc" class="font-semibold">Portions</a>
          {% endif %}
        </th>
        <th class="p-3 text-center">
          {% if current_sort == 'cook_time' %}
            {% if current_dir == 'asc' %}
              <a href="?sort=cook_time&dir=desc" class="font-semibold">Cook Time ‚ñ≤</a>
            {% else %}
              <a href="?sort=cook_time&dir=asc" class="font-semibold">Cook Time ‚ñº</a>
            {% endif %}
          {% else %}
            <a href="?sort=cook_time&dir=asc" class="font-semibold">Cook Time</a>
          {% endif %}
        </th>
        <th class="p-3 text-center">
          {% if current_sort == 'created_at' %}
            {% if current_dir == 'asc' %}
              <a href="?sort=created_at&dir=desc" class="font-semibold">Created At ‚ñ≤</a>
            {% else %}
              <a href="?sort=created_at&dir=asc" class="font-semibold">Created At ‚ñº</a>
            {% endif %}
          {% else %}
            <a href="?sort=created_at&dir=asc" class="font-semibold">Created At</a>
          {% endif %}
        </th>
        <th class="p-3 text-center">Copy</th>
      </tr>
    </thead>

    <tbody class="divide-y divide-gray-100 dark:divide-slate-700">
      {% for recipe in page_obj %}
      <tr class="hover:bg-gray-50/80 dark:hover:bg-slate-800/60" data-ingredients="{{ recipe.ingredients_csv|default:''|lower }}">
        <td class="p-3 align-middle">
          {% if recipe.image %}
            <img src="{{ recipe.image.url }}" alt="{{ recipe.title }} preview" class="h-12 w-16 object-cover rounded-lg ring-1 ring-black/5" loading="lazy">
          {% else %}
            <div class="h-12 w-16 grid place-items-center rounded-lg bg-gray-100 text-gray-400 ring-1 ring-black/5">N/A</div>
          {% endif %}
        </td>
        <td class="p-3 align-middle min-w-[16rem]">
          <div class="leading-tight">
            <a href="{% url 'recipes:recipe_detail' recipe.recipe_id %}" class="font-semibold hover:underline">{{ recipe.title }}</a>
          </div>
          <div class="text-xs text-gray-500 mt-1">Added {{ recipe.created_at|date:"d.m.Y" }}</div>
        </td>
        <td class="p-3 align-middle text-center">{{ recipe.portions }}</td>
        <td class="p-3 align-middle text-center">{{ recipe.cook_time }}</td>
        <td class="p-3 align-middle text-center">{{ recipe.created_at|date:"d.m.Y" }}</td>
        <td class="p-3 align-middle text-center">
          <a href="{% url 'recipes:copy_recipe' recipe.recipe_id %}?next={{ request.get_full_path|urlencode }}"
             class="inline-flex items-center gap-1 rounded-lg bg-emerald-600 text-white px-2.5 py-1.5 text-sm font-semibold hover:bg-emerald-700">
            <span class="material-symbols-rounded text-base">content_copy</span> Copy
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Pagination (JS updates this in filtered mode) -->
  <div id="pagination" class="mt-4 flex flex-wrap items-center justify-center gap-2 text-sm">
    {% if page_obj.has_previous %}
      <a class="inline-flex items-center gap-1 rounded-lg ring-1 ring-black/5 bg-white dark:bg-slate-700 px-3 py-2 font-semibold hover:shadow-card" href="?page=1{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_dir %}&dir={{ current_dir }}{% endif %}">&laquo; First</a>
      <a class="inline-flex items-center gap-1 rounded-lg ring-1 ring-black/5 bg-white dark:bg-slate-700 px-3 py-2 font-semibold hover:shadow-card" href="?page={{ page_obj.previous_page_number }}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_dir %}&dir={{ current_dir }}{% endif %}">Previous</a>
    {% endif %}
    <span id="pageLabel" class="px-3 py-2 rounded-lg bg-gray-50 dark:bg-slate-800 ring-1 ring-black/5">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a class="inline-flex items-center gap-1 rounded-lg ring-1 ring-black/5 bg-white dark:bg-slate-700 px-3 py-2 font-semibold hover:shadow-card" href="?page={{ page_obj.next_page_number }}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_dir %}&dir={{ current_dir }}{% endif %}">Next</a>
      <a class="inline-flex items-center gap-1 rounded-lg ring-1 ring-black/5 bg-white dark:bg-slate-700 px-3 py-2 font-semibold hover:shadow-card" href="?page={{ page_obj.paginator.num_pages }}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_dir %}&dir={{ current_dir }}{% endif %}">Last &raquo;</a>
    {% endif %}
  </div>
  {% else %}
    <p class="subtitle mt-4">No shared recipes from {{ friend.username|title }} yet. üç≤</p>
  {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
/* ---------- 0) Build floating header from the real thead, then hide the thead ---------- */
(function(){
  const table = document.getElementById('recipe-table');
  const thead = document.getElementById('real_thead');
  const fh    = document.getElementById('floatingHead');
  if (!table || !thead || !fh) return;

  // a) Build column template from <colgroup>
  const cols = Array.from(table.querySelectorAll('colgroup col'));
  const template = cols.map(c => c.style.width || 'auto').join(' ');
  fh.style.setProperty('--col-template', template);

  // b) Build grid with same content as thead
  const tr = thead.querySelector('tr');
  const ths = Array.from(tr.children);
  const grid = document.createElement('div');
  grid.className = 'fh-grid px-3 py-3 text-sm font-semibold';
  ths.forEach((th) => {
    const cell = document.createElement('div');
    if (th.classList.contains('text-center')) cell.classList.add('text-center');
    if (th.classList.contains('text-right'))  cell.classList.add('text-right');
    cell.innerHTML = th.innerHTML;
    grid.appendChild(cell);
  });
  fh.appendChild(grid);

  // c) Hide the original thead (keep for semantics/sorting)
  thead.classList.add('sr-only-thead');
})();

/* ---------- 1) Sticky offsets + push table down by floating header height ---------- */
(function(){
  const fh = document.getElementById('floatingHead');
  const wrapper = document.getElementById('tableWrapper');
  const header  = document.querySelector('header');

  function applyOffsets(){
    const siteH = header ? header.getBoundingClientRect().height : 64;
    document.documentElement.style.setProperty('--site-header-h', siteH);
    const fhH = fh.getBoundingClientRect().height || 56;
    wrapper.style.setProperty('--fh-h', '10px');
  }
  applyOffsets();
  if (header) new ResizeObserver(applyOffsets).observe(header);
  new ResizeObserver(applyOffsets).observe(fh);
  window.addEventListener('resize', applyOffsets);
})();

/* ---------- 2) Prevent Enter from submitting while typing ---------- */
(function(){
  const stop = e => { if (e.key === 'Enter') e.preventDefault(); };
  document.getElementById('search')?.addEventListener('keydown', stop);
  document.getElementById('ingredient-search')?.addEventListener('keydown', stop);
})();

/* ---------- 3) Filtering (title + ingredients) ---------- */
const state = { selectedIngredients: new Set() };
const getRows = () => document.querySelectorAll('#recipe-table tbody tr');
const rowIngredients = row => (row.getAttribute('data-ingredients')||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
const titleOf = row => (row.querySelector('td:nth-child(2)')?.innerText || '').toLowerCase(); // title is 2nd col (after preview)
function applyFilters(){
  const term = (document.getElementById('search').value||'').toLowerCase();
  const need = Array.from(state.selectedIngredients);
  let visible = 0;
  getRows().forEach(row=>{
    const matchTitle = titleOf(row).includes(term);
    const matchIngs  = need.every(x=> rowIngredients(row).includes(x));
    const show = matchTitle && matchIngs;
    row.style.display = show ? '' : 'none';
    if (show) visible++;
  });
  if (agg.active) updateFilteredPager(visible);
  showHideDropFilters();
}

/* ---------- 4) Persist filters (key is namespaced per friend) ---------- */
function storageKey(){
  return 'friends_list_filters_{{ friend.username|default:"friend"|lower|escapejs }}_v1';
}
function persistFilters(){
  const key = storageKey();
  const title = document.getElementById('search')?.value || '';
  localStorage.setItem(key, JSON.stringify({ title, ingredients: Array.from(state.selectedIngredients) }));
}
(function restore(){
  const key = storageKey();
  try{
    const saved = JSON.parse(localStorage.getItem(key) || '{}');
    if (saved.title) document.getElementById('search').value = saved.title;
    if (saved.ingredients) saved.ingredients.forEach(v => addIngredientChip(v, true));
    applyFilters();
    showHideDropFilters();
  }catch(e){}
})();

/* ---------- 5) Ingredient suggestions + chips ---------- */
(function(){
  const input = document.getElementById('ingredient-search');
  const box   = document.getElementById('ingredient-suggestions');
  const bar   = document.getElementById('ingredient-active-bar');

  let allIngredients = [];
  try { allIngredients = JSON.parse("{{ all_ing_json|default:'[]'|escapejs }}"); } catch(e) { allIngredients = []; }
  if (!allIngredients.length){
    const set = new Set(); getRows().forEach(r=> rowIngredients(r).forEach(i=> set.add(i)));
    allIngredients = Array.from(set).sort();
  }

  function renderSuggestions(term){
    const t = (term||'').toLowerCase().trim();
    const matches = t ? allIngredients.filter(i=> i.startsWith(t) && !state.selectedIngredients.has(i)) : [];
    box.innerHTML = matches.map(m=>`<button type="button" class="block w-full text-left px-3 py-2 hover:bg-gray-50 dark:hover:bg-slate-700">${m}</button>`).join('');
    box.classList.toggle('hidden', matches.length===0);
    Array.from(box.children).forEach(btn => btn.addEventListener('click', ()=>{
      addIngredientChip(btn.textContent);
      input.value=''; renderSuggestions('');
    }));
  }

  input?.addEventListener('input', ()=> renderSuggestions(input.value));
  input?.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && input.value.trim()){
      e.preventDefault();
      addIngredientChip(input.value.trim());
      input.value=''; renderSuggestions('');
    }
  });
  document.addEventListener('click', (e)=>{ if(!e.target.closest('#ingredient-search-container')) box.classList.add('hidden'); });

  document.getElementById('drop_filters_btn')?.addEventListener('click', dropFilters);
  window.__addIngredientChip = addIngredientChip; // for restore
})();

function addIngredientChip(raw, isRestore=false){
  const bar = document.getElementById('ingredient-active-bar');
  const v = String(raw).toLowerCase().trim();
  if (!v || state.selectedIngredients.has(v)) return;
  state.selectedIngredients.add(v);
  const chip = document.createElement('span');
  chip.className = 'chip inline-flex items-center gap-1 rounded-lg bg-emerald-100 text-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-200 px-2 py-1 text-xs font-semibold';
  chip.dataset.value = v;
  chip.innerHTML = `${v}<button type="button" class="ml-1 rounded hover:bg-black/10 px-1">√ó</button>`;
  chip.querySelector('button').addEventListener('click', ()=>{
    state.selectedIngredients.delete(v);
    chip.remove();
    filtersChanged();
  });
  bar.appendChild(chip);
  if (!isRestore) filtersChanged();
}

/* ---------- 6) Aggregated filtering across ALL pages ---------- */
const agg = { active:false, loaded:false, rowsHTML:'', pagerHTML:'' };

function findPager(){ return document.getElementById('pagination'); }
function getTotalPages(){
  const last = Array.from(document.querySelectorAll('#pagination a')).find(a=> /Last/i.test(a.textContent) && a.href.includes('page='));
  if (last){ const m = last.href.match(/page=(\d+)/i); if (m) return parseInt(m[1],10); }
  const lbl = document.getElementById('pageLabel');
  if (lbl){ const m = (lbl.textContent||'').match(/of\s+(\d+)/i); if (m) return parseInt(m[1],10); }
  return 1;
}

async function loadAllPagesOnce(){
  if (agg.loaded) return;
  const tbody = document.querySelector('#recipe-table tbody');
  agg.originalTbodyHTML = tbody.innerHTML;

  const total = getTotalPages();
  const curURL = new URL(window.location.href);
  const curPage = curURL.searchParams.get('page') || '1';

  const chunks = [tbody.innerHTML];
  for (let p=1; p<=total; p++){
    if (String(p) === String(curPage)) continue;
    curURL.searchParams.set('page', p);
    try{
      const res = await fetch(curURL.toString(), { credentials:'same-origin' });
      const html = await res.text();
      const doc  = new DOMParser().parseFromString(html, 'text/html');
      const t    = doc.querySelector('#recipe-table tbody');
      if (t) chunks.push(t.innerHTML);
    }catch(_){}
  }
  agg.rowsHTML = chunks.join('');
  agg.loaded = true;
}

async function enterAggregatedMode(){
  if (!agg.active){
    const pager = findPager();
    if (pager) agg.pagerHTML = pager.innerHTML;
  }
  await loadAllPagesOnce();
  const tbody = document.querySelector('#recipe-table tbody');
  tbody.innerHTML = agg.rowsHTML;
  agg.active = true;
  updateFilteredPager();
}

function exitAggregatedMode(){
  if (!agg.active) return;
  const tbody = document.querySelector('#recipe-table tbody');
  tbody.innerHTML = agg.originalTbodyHTML || tbody.innerHTML;
  const pager = findPager();
  if (pager && agg.pagerHTML) pager.innerHTML = agg.pagerHTML;
  agg.active = false;
}

function updateFilteredPager(count){
  const pager = findPager(); if (!pager) return;
  pager.querySelectorAll('a').forEach(a=> a.style.display = 'none');
  let label = document.getElementById('pageLabel');
  if (!label){
    label = document.createElement('span');
    label.id = 'pageLabel';
    label.className = 'px-3 py-2 rounded-lg bg-gray-50 dark:bg-slate-800 ring-1 ring-black/5';
    pager.appendChild(label);
  }
  const rows = document.querySelectorAll('#recipe-table tbody tr');
  let visible = (typeof count === 'number') ? count : 0;
  if (typeof count !== 'number'){ rows.forEach(r=>{ if (r.style.display !== 'none') visible++; }); }
  label.textContent = `Showing all ${visible} filtered result${visible===1?'':'s'}`;
}

/* Orchestration when filters change */
let lastKey = null, resetT = null;
function filtersChanged(){
  applyFilters(); persistFilters();
  const term = (document.getElementById('search').value||'').trim().toLowerCase();
  const ings = Array.from(state.selectedIngredients).sort().join(',');
  const key  = term + '|' + ings;

  if (!term && !ings){
    exitAggregatedMode();
    const url = new URL(window.location.href); url.searchParams.set('page','1'); history.replaceState(null,'',url.toString());
    showHideDropFilters();
    return;
  }

  (async ()=>{
    await enterAggregatedMode();
    applyFilters();
    if (key !== lastKey){
      clearTimeout(resetT);
      resetT = setTimeout(()=>{
        const url = new URL(window.location.href);
        url.searchParams.set('page','1');
        history.replaceState(null,'',url.toString());
      }, 120);
    }
    lastKey = key;
  })();
}

function showHideDropFilters(){
  const btn = document.getElementById('drop_filters_btn');
  if (!btn) return;
  const hasTitle = !!(document.getElementById('search').value||'').trim();
  const hasIngs  = state.selectedIngredients.size > 0;
  btn.classList.toggle('hidden', !(hasTitle || hasIngs));
}

function dropFilters(){
  // Clear UI + state
  document.getElementById('search').value = '';
  state.selectedIngredients.clear();
  document.querySelectorAll('#ingredient-active-bar .chip').forEach(c=> c.remove());

  // Clear any persisted filter keys for this friend
  try {
    const toDelete = [];
    for (let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if (k && k.startsWith('friends_list_filters_')) toDelete.push(k);
    }
    toDelete.forEach(k => localStorage.removeItem(k));
  } catch(e){}

  // Reload base URL (no params)
  window.location.replace(window.location.pathname);
}

document.getElementById('search')?.addEventListener('input', filtersChanged);
</script>
{% endblock %}
