{% extends "base.html" %}

{% block title %}Home | Recipe Manager{% endblock %}

{% block content %}
{# Icon font (no images to host): Material Symbols Rounded #}
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@400;700" rel="stylesheet">

<div class="home-header">
  <h2>üëã Welcome to RecipeManager, {{ user.username|default:"Guest" }}!</h2>
  <p class="subtitle">Your personal assistant for delicious, organized, and AI-powered recipes.</p>
</div>

{% if user.is_authenticated %}
  {# keep logout behavior consistent with the rest of the app (GET link) #}
  <div class="auth-links">
    <a href="{% url 'accounts:logout' %}" class="btn-auth" style="background:#dc3545">üö™ Logout</a>
  </div>
{% else %}
  <div class="auth-links">
    <a href="{% url 'accounts:login' %}" class="btn-auth">üîë Login</a>
    <a href="{% url 'accounts:register' %}" class="btn-auth">üìù Register</a>
  </div>
{% endif %}

<!-- üçΩÔ∏è Featured Recipes (unchanged behavior) -->
<div class="card">
  <h3 class="section-title">üçΩÔ∏è Featured Recipes</h3>
  <div id="image-showcase" class="image-grid">
    {% for recipe in random_images|slice:":6" %}
      <div>
        <a href="{% url 'recipes:recipe_detail' recipe.recipe_id %}">
          <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}" class="recipe-thumb" loading="lazy">
        </a>
        <div class="username-under-thumb">
          <span>@{{ recipe.user.username|cut:"_" }}</span>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- üß∞ Toolbox (unchanged) -->
<div class="card">
  <h3 class="section-title">üß∞ Toolbox</h3>
  <p class="subtitle">Create or import recipes using AI assistance:</p>
  <div class="toolbox">
    <a href="{% url 'recipes:create_recipe' %}" class="tool-btn">üëΩ Create Recipe</a>
    <a href="{% url 'recipes:add_recipe_from_url' %}" class="tool-btn">ü§ñ Import from URL</a>
    <a href="{% url 'recipes:add_recipe_from_image' %}" class="tool-btn">üì∑ Import from Image</a>
  </div>
</div>

{# üî• Friends List #}
{% if user.is_authenticated %}
  <div class="card">
    <h3 class="section-title">üë• Your Friends</h3>

    {% if friends %}
      <div class="friends-grid">
        {% for friend in friends %}
          <div class="friend-card">
            <div class="friend-avatar">
              <span class="material-symbols-rounded icon-avatar">
                {{ friend.profile_icon|default:"restaurant" }}
              </span>
            </div>
            <div class="friend-info">
              <div class="friend-name">
                {# Robust name display: username -> full_name -> email local part -> fallback #}
                {% if friend.username %}
                  @{{ friend.username|cut:"_" }}
                {% elif friend.get_full_name %}
                  {{ friend.get_full_name }}
                {% elif friend.email %}
                  @{{ friend.email|cut:"@" }}
                {% else %}
                  @friend
                {% endif %}
              </div>
              <div class="friend-actions">
                {# Link to your existing friends_recipes route (works like dashboard) #}
                <a class="friend-btn" href="{% url 'recipes:friends_recipes' friend.id %}">
                  üìñ See recipes
                </a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="subtitle">
        No friends yet. Visit your
        <a class="inline-link" href="{% url 'accounts:friend_dashboard' %}">Friends dashboard</a>
        to add some!
      </p>
    {% endif %}

    <div class="account-settings-cta">
      <a href="{% url 'accounts:settings' %}" class="settings-btn">‚öôÔ∏è Account Settings</a>
      <span class="muted-note">Change your username, password, and pick your profile icon.</span>
    </div>
  </div>
{% endif %}

{# ====== Data for rotator (images + links + usernames) ====== #}
<script id="image-data" type="application/json">
  [
    {% for r in random_images %}
      "{{ r.image.url|escapejs }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]
</script>
<script id="link-data" type="application/json">
  [
    {% for r in random_images %}
      "{% url 'recipes:recipe_detail' r.recipe_id %}"{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]
</script>
<script id="user-data" type="application/json">
  [
    {% for r in random_images %}
      "@{{ r.user.username|cut:'_'|escapejs }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]
</script>

<script>
  // üîÅ Random image rotator ‚Äì keeps usernames visible after each rotation
  (function(){
    const imgNode  = document.getElementById('image-data');
    const linkNode = document.getElementById('link-data');
    const userNode = document.getElementById('user-data');
    if (!imgNode || !linkNode || !userNode) return;

    const images = JSON.parse(imgNode.textContent || "[]");
    const links  = JSON.parse(linkNode.textContent || "[]");
    const users  = JSON.parse(userNode.textContent || "[]");
    if (!images.length) return;

    let index = 0;
    setInterval(() => {
      const container = document.getElementById('image-showcase');
      if (!container) return;
      container.innerHTML = '';
      for (let i = 0; i < 6 && i < images.length; i++) {
        const idx = (index + i) % images.length;

        const img = document.createElement('img');
        img.src = images[idx];
        img.className = 'recipe-thumb';
        img.loading = 'lazy';

        const a = document.createElement('a');
        a.href = links[idx] || '#';
        a.appendChild(img);

        const name = document.createElement('div');
        name.className = 'username-under-thumb';
        name.textContent = users[idx] || '';

        const wrapper = document.createElement('div');
        wrapper.appendChild(a);
        wrapper.appendChild(name);
        container.appendChild(wrapper);
      }
      index = (index + 6) % images.length;
    }, 10000);
  })();
</script>

<style>
  /* Make Material Symbols render nicely */
  .material-symbols-rounded {
    font-variation-settings: 'FILL' 0, 'wght' 600, 'GRAD' 0, 'opsz' 24;
  }

  .home-header { text-align: center; margin-bottom: 1.25rem; }
  .auth-links { text-align: center; margin-bottom: 1.25rem; }
  .btn-auth {
    padding: 0.5rem 1rem; margin: 0 0.5rem;
    background: var(--primary-color); color: #fff; border-radius: 6px;
    text-decoration: none; font-weight: 600;
  }

  .image-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem; margin-top: 1rem;
  }
  .recipe-thumb {
    width: 100%; height: 100px; object-fit: cover; border-radius: 8px;
    border: 2px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: transform 0.2s;
  }
  .recipe-thumb:hover { transform: scale(1.05); }
  .username-under-thumb { font-size: .9rem; margin-top: .35rem; color: #555; text-decoration: none; }

  .toolbox { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; }
  .tool-btn {
    flex: 1; padding: 0.75rem; background: #f5f5f5; border-radius: 8px; border: 1px solid #ddd;
    text-align: center; text-decoration: none; font-weight: 600; color: #333; transition: background-color .2s;
  }
  .tool-btn:hover { background: #e0e0e0; }

  /* ===== Friends list ===== */
  .friends-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: .75rem; margin-top: .75rem;
  }
  .friend-card {
    display: grid; grid-template-columns: auto 1fr; gap: .75rem;
    align-items: center; padding: .6rem .75rem;
    border: 1px solid #e5e7eb; border-radius: 10px; background: #fafafa;
  }
  .friend-avatar {
    width: 50px; height: 50px; border-radius: 12px;
    background: #eef7ee; display: grid; place-items: center; border: 1px solid #e0f0e0;
  }
  .icon-avatar { font-size: 28px; line-height: 1; color: var(--primary-color); }
  .friend-info { display: grid; gap: .25rem; }
  .friend-name { font-weight: 700; color: #1f2937; }
  .friend-actions { display: flex; gap: .5rem; flex-wrap: wrap; }
  .friend-btn {
    display: inline-block; padding: .35rem .6rem; border-radius: 8px; border: 1px solid #cfe4d0;
    background: #f1f9f2; color: #1f2937; text-decoration: none; font-weight: 600; font-size: .9rem;
  }
  .friend-btn:hover { background: #e5f3e6; }

  /* Account settings CTA aligned nicely with its text */
  .account-settings-cta {
    display: flex; align-items: center; gap: .6rem; flex-wrap: wrap;
    margin-top: .9rem;
  }
  .settings-btn {
    display: inline-block; padding: .55rem .9rem; border-radius: 10px; border: 1px solid #d7dee3;
    background: #f4f6f8; color: var(--text-color); text-decoration: none; font-weight: 700;
  }
  .settings-btn:hover { background: #e9eef2; }
  .inline-link { color: var(--primary-color); text-decoration: none; font-weight: 600; }
  .inline-link:hover { text-decoration: underline; }
  .muted-note { color: var(--muted-text); font-size: .9rem; }

  /* Mobile tweaks */
  @media (max-width: 768px){
    .recipe-thumb { height: 110px; }
    .friends-grid { grid-template-columns: 1fr; }
  }
</style>
{% endblock %}
