{% extends "base.html" %}

{% block title %}Home | Recipe Manager{% endblock %}

{% block content %}
<!-- Hero / Welcome -->
<section class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-emerald-50 to-emerald-100 dark:from-slate-800 dark:to-slate-900 p-6 md:p-8 ring-1 ring-black/5">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
    <div>
      <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-emerald-900 dark:text-emerald-200">
        üëã Welcome to RecipeManager, {{ user.username|default:"Guest" }}!
      </h1>
      <p class="mt-2 text-slate-700 dark:text-slate-300">
        Your personal hub for delicious, organized, and AI‚Äëassisted recipes.
      </p>
      <div class="mt-4 flex flex-wrap gap-2">
        <a href="{% url 'recipes:recipe_list' %}" class="inline-flex items-center gap-2 rounded-xl bg-white text-emerald-700 dark:bg-slate-700 dark:text-slate-100 px-3 py-2 font-semibold ring-1 ring-black/5 hover:shadow-card">
          <span class="material-symbols-rounded">menu_book</span> My Recipes
        </a>
        <a href="{% url 'recipes:public_recipes' %}" class="inline-flex items-center gap-2 rounded-xl bg-white text-emerald-700 dark:bg-slate-700 dark:text-slate-100 px-3 py-2 font-semibold ring-1 ring-black/5 hover:shadow-card">
          <span class="material-symbols-rounded">public</span> Explore Public Recipes
        </a>
      </div>
    </div>

    <!-- Quick Account Actions -->
    <div class="shrink-0">
      {% if user.is_authenticated %}
        <div class="flex items-center gap-2">
          <a href="{% url 'accounts:logout' %}" class="inline-flex items-center gap-2 rounded-xl bg-rose-600 text-white px-3 py-2 font-semibold hover:bg-rose-700">
            <span class="material-symbols-rounded">logout</span> Logout
          </a>
          <a href="{% url 'accounts:settings' %}" class="inline-flex items-center gap-2 rounded-xl bg-white text-slate-800 dark:bg-slate-700 dark:text-slate-100 px-3 py-2 font-semibold ring-1 ring-black/5 hover:shadow-card">
            <span class="material-symbols-rounded">settings</span> Settings
          </a>
        </div>
      {% else %}
        <div class="flex items-center gap-2">
          <a href="{% url 'accounts:login' %}" class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 text-white px-3 py-2 font-semibold hover:bg-emerald-700">
            <span class="material-symbols-rounded">login</span> Login
          </a>
          <a href="{% url 'accounts:register' %}" class="inline-flex items-center gap-2 rounded-xl bg-white text-emerald-700 dark:bg-slate-700 dark:text-slate-100 px-3 py-2 font-semibold ring-1 ring-black/5 hover:shadow-card">
            <span class="material-symbols-rounded">how_to_reg</span> Register
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</section>

<!-- Featured Recipes -->
<section class="mt-8">
  <div class="flex items-center justify-between">
    <h2 class="text-lg md:text-xl font-bold">üåÆ Featured Recipes</h2>
    <details class="help-popover inline-block align-middle">
      <summary class="help-badge bg-brand/15 text-brand hover:bg-brand/20 select-none">?</summary>
      <div class="mt-2 w-80 max-w-[90vw] p-3 bg-white dark:bg-slate-800 rounded-xl shadow-card ring-1 ring-black/5 text-sm leading-relaxed">
        Here you can find random public recipes shared by other users. Click on a recipe to view its details, or change the visibility of your recipes to public, to also be featured in this section!
      </div>
    </details>
  </div>

  {% if random_images %}
    <div id="image-showcase" class="mt-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
      {% for recipe in random_images|slice:":6" %}
        <div class="group relative overflow-hidden rounded-xl ring-1 ring-black/5 bg-white dark:bg-slate-800">
          <a href="{% url 'recipes:recipe_detail' recipe.recipe_id %}" class="block aspect-[4/3]">
            <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}" class="h-full w-full object-cover transition duration-300 group-hover:scale-105" loading="lazy">
          </a>
          <div class="absolute inset-x-0 bottom-0 p-2 text-xs font-semibold bg-gradient-to-t from-black/60 to-transparent text-white">
            @{{ recipe.user.username|cut:"_" }}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="mt-4 rounded-xl bg-white dark:bg-slate-800 ring-1 ring-black/5 p-6 text-slate-600 dark:text-slate-300">
      No featured images yet. Try <a href="{% url 'recipes:add_recipe_from_url' %}" class="underline font-semibold">importing your first recipe</a> or <a href="{% url 'recipes:public_recipes' %}" class="underline font-semibold">browsing public recipes</a>.
    </div>
  {% endif %}
</section>

<!-- Add Recipes -->
<section class="mt-6 grid gap-4">
  <div class="flex items-center justify-between">
    <h2 class="text-lg md:text-xl font-bold">‚ûï Add new Recipes!</h2>
    <!-- Inline help popover (reusable pattern from base.html) -->
    <details class="help-popover inline-block align-middle">
      <summary class="help-badge bg-brand/15 text-brand hover:bg-brand/20 select-none">?</summary>
      <div class="mt-2 w-80 max-w-[90vw] p-3 bg-white dark:bg-slate-800 rounded-xl shadow-card ring-1 ring-black/5 text-sm leading-relaxed">
        Use <strong>Create</strong> to write a recipe from scratch. <strong>Import from URL</strong> extracts ingredients & steps from recipes from over 900 different supported cooking websites. Find all supported websites 
          <a href="https://docs.recipe-scrapers.com/getting-started/supported-sites/"
        class="inline-link" target="_blank" rel="noopener noreferrer">here</a>.
        <strong>Import from Image</strong> works best with a full‚Äëpage photo or screenshot of a recipe.
      </div>
    </details>
  </div>

  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
    <a href="{% url 'recipes:create_recipe' %}" class="group rounded-2xl p-4 ring-1 ring-black/5 bg-white dark:bg-slate-800 hover:shadow-card transition">
      <div class="flex items-center gap-3">
        <span class="material-symbols-rounded text-2xl">psychiatry</span>
        <div>
          <div class="font-semibold">Create Recipe</div>
          <p class="text-sm text-slate-600 dark:text-slate-300">Start blank or paste ingredients. AI can help fill in steps.</p>
        </div>
      </div>
    </a>
    <a href="{% url 'recipes:add_recipe_from_url' %}" class="group rounded-2xl p-4 ring-1 ring-black/5 bg-white dark:bg-slate-800 hover:shadow-card transition">
      <div class="flex items-center gap-3">
        <span class="material-symbols-rounded text-2xl">travel_explore</span>
        <div>
          <div class="font-semibold">Import from URL</div>
          <p class="text-sm text-slate-600 dark:text-slate-300">Paste a recipe link. We‚Äôll extract title, image, ingredients & steps.</p>
        </div>
      </div>
    </a>
    <a href="{% url 'recipes:add_recipe_from_image' %}" class="group rounded-2xl p-4 ring-1 ring-black/5 bg-white dark:bg-slate-800 hover:shadow-card transition">
      <div class="flex items-center gap-3">
        <span class="material-symbols-rounded text-2xl">add_a_photo</span>
        <div>
          <div class="font-semibold">Import from Images/Files</div>
          <p class="text-sm text-slate-600 dark:text-slate-300">Upload a photos/screenshots of your recipe or use a Word/PDF file as input.</p>
        </div>
      </div>
    </a>
  </div>
</section>



<!-- Friends -->
{% if user.is_authenticated %}
<section class="mt-8">
  <div class="flex items-center justify-between">
    <h2 class="text-lg md:text-xl font-bold">üë´ Your Friends</h2>
    <details class="help-popover inline-block align-middle">
      <summary class="help-badge bg-brand/15 text-brand hover:bg-brand/20 select-none">?</summary>
      <div class="mt-2 w-80 max-w-[90vw] p-3 bg-white dark:bg-slate-800 rounded-xl shadow-card ring-1 ring-black/5 text-sm leading-relaxed">
        Friends can see all the recipes you actively share with them! And of course, you can browse theirs. Add or accept requests in your Friends dashboard and ask them to share recipes with you by setting their recipe's visibility to "Friends" or "Public".
      </div>
    </details>
  </div>

  {% if friends %}
    <ul class="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
      {% for friend in friends %}
        <li class="rounded-2xl ring-1 ring-black/5 bg-white dark:bg-slate-800 p-4 flex items-center gap-3">
          <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-emerald-50 dark:bg-slate-700 ring-1 ring-black/5">
            <span class="material-symbols-rounded text-2xl text-emerald-600 dark:text-emerald-300">{{ friend.profile_icon|default:"üêæ" }}</span>
          </div>
          <div class="min-w-0 flex-1">
            <div class="font-semibold truncate">
              {% if friend.username %}
                @{{ friend.username|cut:"_" }}
              {% elif friend.get_full_name %}
                {{ friend.get_full_name }}
              {% elif friend.email %}
                @{{ friend.email|cut:"@" }}
              {% else %}
                @friend
              {% endif %}
            </div>
            <div class="mt-1 flex flex-wrap gap-2">
              <a class="inline-flex items-center gap-1 rounded-lg bg-emerald-600 text-white px-2.5 py-1.5 text-sm font-semibold hover:bg-emerald-700" href="{% url 'recipes:friends_recipes' friend.id %}">
                <span class="material-symbols-rounded text-base">menu_book</span> See recipes
              </a>
            </div>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="mt-4 rounded-xl bg-white dark:bg-slate-800 ring-1 ring-black/5 p-6 text-slate-600 dark:text-slate-300">
      No friends yet. Visit your <a class="underline font-semibold" href="{% url 'accounts:friend_dashboard' %}">Friends dashboard</a> to add some!
    </div>
  {% endif %}
</section>
{% endif %}

<!-- Hidden JSON data for rotator -->
<script id="image-data" type="application/json">[
  {% for r in random_images %}
    "{{ r.image.url|escapejs }}"{% if not forloop.last %},{% endif %}
  {% endfor %}
]</script>
<script id="link-data" type="application/json">[
  {% for r in random_images %}
    "{% url 'recipes:recipe_detail' r.recipe_id %}"{% if not forloop.last %},{% endif %}
  {% endfor %}
]</script>
<script id="user-data" type="application/json">[
  {% for r in random_images %}
    "@{{ r.user.username|cut:'_'|escapejs }}"{% if not forloop.last %},{% endif %}
  {% endfor %}
]</script>
{% endblock %}

{% block extra_scripts %}
<script>
  // Rotating featured images every 10s, preserving existing behavior
  (function(){
    const imgNode  = document.getElementById('image-data');
    const linkNode = document.getElementById('link-data');
    const userNode = document.getElementById('user-data');
    if (!imgNode || !linkNode || !userNode) return;

    const images = JSON.parse(imgNode.textContent || '[]');
    const links  = JSON.parse(linkNode.textContent || '[]');
    const users  = JSON.parse(userNode.textContent || '[]');
    if (!images.length) return;

    let index = 0;
    const container = document.getElementById('image-showcase');
    function render(){
      if (!container) return;
      container.style.opacity = '0';
      setTimeout(()=>{
        container.innerHTML = '';
        for (let i = 0; i < 6 && i < images.length; i++) {
          const idx = (index + i) % images.length;
          const outer = document.createElement('div');
          outer.className = 'group relative overflow-hidden rounded-xl ring-1 ring-black/5 bg-white dark:bg-slate-800';

          const a = document.createElement('a');
          a.href = links[idx] || '#';
          a.className = 'block aspect-[4/3]';

          const img = document.createElement('img');
          img.src = images[idx];
          img.alt = users[idx] || 'Recipe image';
          img.loading = 'lazy';
          img.className = 'h-full w-full object-cover transition duration-300 group-hover:scale-105';
          a.appendChild(img);

          const label = document.createElement('div');
          label.className = 'absolute inset-x-0 bottom-0 p-2 text-xs font-semibold bg-gradient-to-t from-black/60 to-transparent text-white';
          label.textContent = users[idx] || '';

          outer.appendChild(a);
          outer.appendChild(label);
          container.appendChild(outer);
        }
        container.style.opacity = '1';
        index = (index + 6) % images.length;
      }, 150);
    }
    render();
    setInterval(render, 10000);
  })();
</script>


<style> 
  .inline-link { color: #1a73e8; text-decoration: underline; }
</style>
{% endblock %}
