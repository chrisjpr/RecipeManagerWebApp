{% extends 'base.html' %}
{% load static %}

{% block content %}
<h2>Create a Recipe</h2>
<form method="post" enctype="multipart/form-data" id="recipeForm">
  {% csrf_token %}
  {{ recipe_form.as_p }}

  <h3>Ingredients</h3>
  <div id="ingredients-formset">
    {{ ingredient_formset.management_form }}
    {% for form in ingredient_formset %}
      <div class="ingredients-form form-inline">
        {% for field in form.visible_fields %}
          <div class="form-group">
            {{ field.label_tag }} {{ field }}
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>
  <button type="button" id="add-ingredient">➕ Add Ingredient</button>

  <h3>Instructions</h3>
  <div id="instructions-formset">
    {{ instruction_formset.management_form }}
    {% for form in instruction_formset %}
      <div class="instructions-form form-inline">
        {% for field in form.visible_fields %}
          <div class="form-group">
            {{ field.label_tag }} {{ field }}
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>
  <button type="button" id="add-instruction">➕ Add Instruction</button>

  <br><br>
  <button type="submit">Save Recipe</button>
</form>

<!-- HIDDEN TEMPLATE FOR JS CLONING -->
<div id="empty-ingredients-form" style="display: none;">
  <div class="ingredients-form form-inline">
    {% for field in ingredient_formset.empty_form.visible_fields %}
      <div class="form-group">
        {{ field.label_tag }} {{ field }}
      </div>
    {% endfor %}
  </div>
</div>

<div id="empty-instructions-form" style="display: none;">
  <div class="instructions-form form-inline">
    {% for field in instruction_formset.empty_form.visible_fields %}
      <div class="form-group">
        {{ field.label_tag }} {{ field }}
      </div>
    {% endfor %}
  </div>
</div>

<style>
  .form-inline {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }
  .form-group {
    display: flex;
    flex-direction: column;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  function addForm(prefix) {
    const totalForms = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
    const formsetDiv = document.getElementById(`${prefix}-formset`);
    const newIndex = parseInt(totalForms.value);

    const emptyFormTemplate = document.getElementById(`empty-${prefix}-form`).innerHTML;
    const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, newIndex);

    const wrapper = document.createElement('div');
    wrapper.innerHTML = newFormHtml;
    formsetDiv.appendChild(wrapper.firstElementChild);

    totalForms.value = newIndex + 1;
  }

  document.getElementById('add-ingredient').addEventListener('click', function () {
    addForm('ingredients');
  });

  document.getElementById('add-instruction').addEventListener('click', function () {
    addForm('instructions');
  });
});
</script>
{% endblock %}
